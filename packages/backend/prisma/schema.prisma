// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Seed configuration

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         String // PATIENT, PROVIDER, MEDICAL_ASSISTANT, ADMIN
  clinicId     String?  @map("clinic_id")
  patientId    String?  @unique @map("patient_id")
  providerId   String?  @unique @map("provider_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  clinic        Clinic?        @relation(fields: [clinicId], references: [id])
  patient       Patient?       @relation("PatientToUser")
  provider      Provider?      @relation("ProviderToUser")
  refreshTokens RefreshToken[]
  devices       UserDevice[]
  sessions      UserSession[]

  @@map("users")
}

model Clinic {
  id             String   @id @default(uuid())
  name           String
  brandingConfig Json?    @map("branding_config")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  users     User[]
  patients  Patient[]
  providers Provider[]

  @@map("clinics")
}

model Patient {
  id                 String    @id @default(uuid())
  userId             String    @unique @map("user_id")
  clinicId           String    @map("clinic_id")
  firstName          String?   @map("first_name")
  lastName           String?   @map("last_name")
  dateOfBirth        DateTime? @map("date_of_birth")
  heightCm           Float?    @map("height_cm")
  demographics       Json?
  flags              String[]
  preferredLanguage  String?   @map("preferred_language") // ISO language code (e.g., 'en', 'es', 'ja', 'zh', 'tl', 'sm')
  lastDetectedLanguage String? @map("last_detected_language") // Last detected language from messages
  regionCode         String?   @map("region_code") // e.g., 'US', 'GUAM', 'HI', 'DEFAULT'
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  user            User              @relation("PatientToUser", fields: [userId], references: [id])
  clinic          Clinic            @relation(fields: [clinicId], references: [id])
  measurements    Measurement[]
  carePlans       CarePlan[]
  alerts          Alert[]
  visitRequests   VisitRequest[]
  visits          Visit[]
  ruleExecutions  RuleExecution[]
  messageThreads  MessageThread[]
  weeklySummaries WeeklySummary[]
  devices         DeviceConnection[]
  vitals          VitalReading[]
  hrvReadings     HRVReading[]
  bmiReadings     BMIReading[]
  labOrders       LabOrder[]
  referrals       Referral[]
  excuseNotes     ExcuseNote[]
  clinicalNotes   ClinicalNote[]
  voiceMessages   VoiceMessage[]
  voiceMessageAuditLogs VoiceMessageAuditLog[]
  triageTasks     TriageTask[]

  @@map("patients")
}

model Provider {
  id             String   @id @default(cuid())
  name           String
  specialties    String[]
  telemedEnabled Boolean  @default(true)
  userId         String?  @unique @map("user_id")
  clinicId       String?  @map("clinic_id")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user         User?                  @relation("ProviderToUser", fields: [userId], references: [id])
  clinic       Clinic?                @relation(fields: [clinicId], references: [id])
  availability ProviderAvailability[]
  slots        VisitSlot[]
  visits       Visit[]

  @@map("providers")
}

model Measurement {
  id        String   @id @default(uuid())
  patientId String   @map("patient_id")
  type      String // BLOOD_PRESSURE, GLUCOSE, WEIGHT, etc.
  value     Json // Can be number or object (e.g., {systolic: 120, diastolic: 80})
  timestamp DateTime
  source    String // "HEALTHKIT", "MANUAL", "DEVICE"
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, timestamp])
  @@index([patientId, type, timestamp])
  @@map("measurements")
}

model CarePlan {
  id        String   @id @default(uuid())
  patientId String   @map("patient_id")
  phases    Json // Array of CarePlanPhase
  // Multilingual fields
  planEnglishTitle  String? @map("plan_english_title")
  planEnglishBody   Json?   @map("plan_english_body") // English canonical version of phases
  planTranslatedTitle String? @map("plan_translated_title")
  planTranslatedBody  Json?   @map("plan_translated_body") // Translated version
  planTranslatedLanguage String? @map("plan_translated_language") // Language code for translation
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("care_plans")
}

model Alert {
  id         String    @id @default(uuid())
  patientId  String    @map("patient_id")
  severity   String // INFO, WARNING, CRITICAL
  type       String // BP_HIGH_TREND, GLUCOSE_HIGH, etc.
  title      String
  body       String
  payload    Json?
  status     String    @default("ACTIVE") // ACTIVE, RESOLVED, DISMISSED
  createdAt  DateTime  @default(now()) @map("created_at")
  resolvedAt DateTime? @map("resolved_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, status])
  @@index([status, createdAt])
  @@map("alerts")
}

model VisitRequest {
  id             String        @id @default(cuid())
  patientId      String        @map("patient_id")
  requestType    RequestType
  visitMode      VisitMode
  requestedDate  DateTime?     @map("requested_date")
  windowStart    DateTime?     @map("window_start")
  windowEnd      DateTime?     @map("window_end")
  reasonText     String        @map("reason_text")
  reasonCategory String?       @map("reason_category")
  severity       SeverityLevel @default(GREEN)
  status         RequestStatus @default(NEW)
  proposedSlotId String?       @map("proposed_slot_id")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, status])
  @@index([status, createdAt])
  @@map("visit_requests")
}

model WeeklySummary {
  id        String   @id @default(uuid())
  patientId String   @map("patient_id")
  weekStart DateTime @map("week_start")
  weekEnd   DateTime @map("week_end")
  summary   Json // { bpTrend, glucoseTrend, weightTrend, steps, sleep, adherence, recommendations }
  createdAt DateTime @default(now()) @map("created_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@unique([patientId, weekStart])
  @@index([patientId, weekStart])
  @@map("weekly_summaries")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model MessageThread {
  id            String    @id @default(uuid())
  patientId     String    @map("patient_id")
  clinicId      String?   @map("clinic_id")
  participants  Json // Array of user IDs
  subject       String?
  lastMessageAt DateTime? @map("last_message_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  patient  Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([patientId])
  @@index([clinicId])
  @@map("message_threads")
}

model Message {
  id                    String    @id @default(uuid())
  threadId              String    @map("thread_id")
  senderId              String    @map("sender_id")
  content               String
  attachments           Json? // Array of { type, url, filename, size }
  read                  Boolean   @default(false)
  readAt                DateTime? @map("read_at")
  // Multilingual fields
  originalText          String?   @map("original_text") // Original patient text in their language
  originalLanguage      String?   @map("original_language") // ISO language code
  englishText           String?   @map("english_text") // Translated to English for processing
  processedLanguage     String?   @default("en") @map("processed_language") // Language used for triage (always 'en')
  // For assistant responses
  englishTitle          String?   @map("english_title")
  englishBody           String?   @map("english_body")
  translatedTitle       String?   @map("translated_title")
  translatedBody        String?   @map("translated_body")
  patientLanguageUsedForReply String? @map("patient_language_used_for_reply")
  createdAt             DateTime  @default(now()) @map("created_at")

  thread MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
  @@index([senderId])
  @@map("messages")
}

model VoiceMessage {
  id                        String   @id @default(uuid())
  patientId                 String   @map("patient_id")
  triageTaskId              String?  @map("triage_task_id")
  intentType                String   @map("intent_type")
  severity                  String   @map("severity")
  audioUrl                  String?  @map("audio_url")
  audioRetentionExpiresAt   DateTime? @map("audio_retention_expires_at")
  originalTranscript        String   @map("original_transcript")
  originalLanguage          String   @map("original_language")
  englishTranscript         String   @map("english_transcript")
  aiSummary                 String?  @map("ai_summary")
  riskFlags                 Json?    @map("risk_flags")
  isAccessibleToPatient     Boolean  @default(true) @map("is_accessible_to_patient")
  hasAudioAvailableToPatient Boolean @default(false) @map("has_audio_available_to_patient")
  audioDownloadCount        Int      @default(0) @map("audio_download_count")
  lastAudioDownloadAt       DateTime? @map("last_audio_download_at")
  intentConfidence          Float?   @map("intent_confidence")
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  patient    Patient    @relation(fields: [patientId], references: [id], onDelete: Cascade)
  triageTask TriageTask? @relation(fields: [triageTaskId], references: [id], onDelete: SetNull)
  auditLogs  VoiceMessageAuditLog[]

  @@index([patientId, createdAt])
  @@index([triageTaskId])
  @@map("voice_messages")
}

model VoiceMessageAuditLog {
  id            String   @id @default(uuid())
  voiceMessageId String  @map("voice_message_id")
  patientId     String   @map("patient_id")
  actorType     String   @map("actor_type") // PATIENT | CLINICIAN | SYSTEM
  actionType    String   @map("action_type") // AUDIO_DOWNLOADED | AUDIO_PLAYED | AUDIO_EXPIRED
  timestamp     DateTime @default(now()) @map("timestamp")
  details       Json?    @map("details")

  voiceMessage VoiceMessage @relation(fields: [voiceMessageId], references: [id], onDelete: Cascade)
  patient      Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([voiceMessageId, timestamp])
  @@index([patientId, timestamp])
  @@map("voice_message_audit_logs")
}

model TriageTask {
  id                   String   @id @default(uuid())
  patientId            String   @map("patient_id")
  createdBy            String   @map("created_by")
  createdByRole        String?  @map("created_by_role")
  intentType           String   @map("intent_type")
  severity             String   @map("severity")
  status               String   @default("OPEN") @map("status")
  assigneeRole         String?  @map("assignee_role")
  supervisingClinicianId String? @map("supervising_clinician_id")
  assignedMAId         String?  @map("assigned_ma_id")
  sourceMessage        String?  @map("source_message")
  sourceOriginalText   String?  @map("source_original_text")
  sourceType           String?  @map("source_type") // voice, text, check-in
  symptomId            String?  @map("symptom_id")
  refillId             String?  @map("refill_id")
  appointmentId        String?  @map("appointment_id")
  adminTaskId          String?  @map("admin_task_id")
  actionNote           String?  @map("action_note")
  openedAt             DateTime @default(now()) @map("opened_at")
  firstActionAt        DateTime? @map("first_action_at")
  lastActionAt         DateTime? @map("last_action_at")
  closedAt             DateTime? @map("closed_at")
  handledByUserId      String?  @map("handled_by_user_id")
  handledByRole        String?  @map("handled_by_role")
  isOverdue            Boolean  @default(false) @map("is_overdue")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  patient      Patient        @relation(fields: [patientId], references: [id], onDelete: Cascade)
  voiceMessages VoiceMessage[]
  logs         TriageTaskLog[]

  @@index([patientId, status])
  @@index([status, severity])
  @@map("triage_tasks")
}

model TriageTaskLog {
  id         String   @id @default(uuid())
  taskId     String   @map("task_id")
  actorId    String?  @map("actor_id")
  actorRole  String   @map("actor_role")
  actionType String   @map("action_type")
  details    Json?    @map("details")
  timestamp  DateTime @default(now()) @map("timestamp")

  task TriageTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId, timestamp])
  @@map("triage_task_logs")
}

enum DevicePlatform {
  IOS
  ANDROID
  WEB
}

model UserDevice {
  id                 String         @id @default(uuid())
  userId             String         @map("user_id")
  deviceId           String         @map("device_id")
  deviceName         String?        @map("device_name")
  platform           DevicePlatform @map("platform")
  biometricEnabled   Boolean        @default(false) @map("biometric_enabled")
  biometricKey       String?        @map("biometric_key")
  pinEnabled         Boolean        @default(false) @map("pin_enabled")
  pinHash            String?        @map("pin_hash")
  encryptedKeyBlob   String?        @map("encrypted_key_blob")
  lastUnlockAt       DateTime?      @map("last_unlock_at")
  idleTimeoutSeconds Int            @default(900) @map("idle_timeout_seconds")
  createdAt          DateTime       @default(now()) @map("created_at")
  updatedAt          DateTime       @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions UserSession[]

  @@unique([userId, deviceId])
  @@index([userId, platform])
  @@map("user_devices")
}

model UserSession {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  deviceId      String    @map("device_id")
  sessionToken  String    @unique @map("session_token")
  lastActiveAt  DateTime  @map("last_active_at")
  expiresAt     DateTime  @map("expires_at")
  revokedAt     DateTime? @map("revoked_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  device UserDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([userId, deviceId])
  @@map("user_sessions")
}

model ClinicalRule {
  id           String   @id @default(uuid())
  name         String
  description  String?
  metric       String // bp, glucose, weight, sleep, hrv, a1c
  windowDays   Int      @default(7)
  condition    Json // { op: '>' | '<' | 'trendUp' | 'trendDown' | 'missing', threshold?: number }
  severity     String // info, warn, critical
  action       String // alert, suggest_visit, assign_task, assign_content
  actionParams Json? // Additional parameters for action (e.g., content module ID, task type)
  enabled      Boolean  @default(true)
  priority     Int      @default(0) // Higher priority rules evaluated first
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  executions RuleExecution[]

  @@index([metric, enabled])
  @@index([enabled, priority])
  @@map("clinical_rules")
}

model RuleExecution {
  id         String   @id @default(uuid())
  ruleId     String   @map("rule_id")
  patientId  String   @map("patient_id")
  triggered  Boolean  @default(false)
  result     Json? // Execution result details
  executedAt DateTime @default(now()) @map("executed_at")

  rule    ClinicalRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  patient Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, executedAt])
  @@index([ruleId, executedAt])
  @@map("rule_executions")
}

model ProviderAvailability {
  id         String             @id @default(cuid())
  providerId String             @map("provider_id")
  provider   Provider           @relation(fields: [providerId], references: [id], onDelete: Cascade)
  date       DateTime?
  dayOfWeek  Int?               @map("day_of_week") // 0-6
  startTime  DateTime           @map("start_time")
  endTime    DateTime           @map("end_time")
  visitMode  VisitMode          @map("visit_mode")
  location   String?
  status     AvailabilityStatus @default(ACTIVE)
  createdAt  DateTime           @default(now()) @map("created_at")
  updatedAt  DateTime           @updatedAt @map("updated_at")

  @@index([providerId, status])
  @@map("provider_availability")
}

model VisitSlot {
  id         String     @id @default(cuid())
  providerId String     @map("provider_id")
  provider   Provider   @relation(fields: [providerId], references: [id], onDelete: Cascade)
  startTime  DateTime   @map("start_time")
  endTime    DateTime   @map("end_time")
  visitMode  VisitMode  @map("visit_mode")
  status     SlotStatus @default(FREE)
  heldUntil  DateTime?  @map("held_until")
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")

  visit Visit?

  @@index([providerId, startTime])
  @@index([status, startTime])
  @@index([heldUntil])
  @@map("visit_slots")
}

model Visit {
  id         String      @id @default(cuid())
  patientId  String      @map("patient_id")
  providerId String      @map("provider_id")
  slotId     String      @unique @map("slot_id")
  provider   Provider    @relation(fields: [providerId], references: [id], onDelete: Cascade)
  patient    Patient     @relation(fields: [patientId], references: [id], onDelete: Cascade)
  slot       VisitSlot   @relation(fields: [slotId], references: [id], onDelete: Cascade)
  visitType  VisitType   @map("visit_type")
  visitMode  VisitMode   @map("visit_mode")
  reasonText String      @map("reason_text")
  status     VisitStatus @default(PLANNED)
  // Multilingual visit summary fields
  summaryEnglish          String? @map("summary_english") // English canonical summary
  summaryTranslated       String? @map("summary_translated") // Translated summary
  summaryTranslatedLanguage String? @map("summary_translated_language") // Language code
  dischargeInstructionsEnglish String? @map("discharge_instructions_english") // English discharge instructions
  dischargeInstructionsTranslated String? @map("discharge_instructions_translated") // Translated discharge instructions
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  virtualSession VirtualVisitSession?
  labOrders      LabOrder[]
  referrals      Referral[]
  excuseNotes    ExcuseNote[]
  clinicalNotes  ClinicalNote[] @relation("VisitClinicalNotes")

  @@index([patientId, status])
  @@index([providerId, status])
  @@index([status, createdAt])
  @@map("visits")
}

model VirtualVisitSession {
  id               String        @id @default(cuid())
  visitId          String        @unique @map("visit_id")
  visit            Visit         @relation(fields: [visitId], references: [id], onDelete: Cascade)
  roomId           String        @map("room_id")
  status           TelemedStatus @default(NOT_STARTED)
  patientJoinedAt  DateTime?     @map("patient_joined_at")
  providerJoinedAt DateTime?     @map("provider_joined_at")
  endedAt          DateTime?     @map("ended_at")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  @@index([roomId])
  @@index([status])
  @@map("virtual_visit_sessions")
}

enum VisitMode {
  VIRTUAL
  IN_PERSON
}

enum VisitType {
  WALK_IN
  SCHEDULED
}

enum RequestType {
  WALK_IN
  SCHEDULED
}

enum SeverityLevel {
  GREEN
  YELLOW
  ORANGE
  RED
}

enum SlotStatus {
  FREE
  HELD
  BOOKED
  BLOCKED
}

enum RequestStatus {
  NEW
  TRIAGED
  AWAITING_PATIENT_CONFIRMATION
  CONVERTED_TO_VISIT
  CANCELLED
}

enum VisitStatus {
  PLANNED
  CHECKED_IN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum TelemedStatus {
  NOT_STARTED
  WAITING
  ACTIVE
  ENDED
}

enum AvailabilityStatus {
  ACTIVE
  PAUSED
}

enum DeviceProvider {
  APPLE
  OURA
  FITBIT
  GARMIN
  WITHINGS
}

enum HRVContext {
  SLEEP
  REST
  WORKOUT
  UNKNOWN
}

model DeviceConnection {
  id           String         @id @default(cuid())
  patientId    String         @map("patient_id")
  provider     DeviceProvider
  externalId   String         @map("external_id")
  accessToken  String         @map("access_token")
  refreshToken String?        @map("refresh_token")
  expiresAt    DateTime?      @map("expires_at")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@unique([patientId, provider, externalId])
  @@index([patientId])
  @@index([provider, externalId])
  @@map("device_connections")
}

model VitalReading {
  id          String         @id @default(cuid())
  patientId   String         @map("patient_id")
  timestamp   DateTime
  source      DeviceProvider
  heartRate   Int?           @map("heart_rate")
  spo2        Int?
  respiration Int?
  systolicBP  Int?           @map("systolic_bp")
  diastolicBP Int?           @map("diastolic_bp")
  createdAt   DateTime       @default(now()) @map("created_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, timestamp])
  @@index([patientId, source, timestamp])
  @@map("vital_readings")
}

model HRVReading {
  id          String         @id @default(cuid())
  patientId   String         @map("patient_id")
  timestamp   DateTime
  source      DeviceProvider
  rmssdMs     Float          @map("rmssd_ms")
  sdnnMs      Float?         @map("sdnn_ms")
  context     HRVContext     @default(UNKNOWN)
  createdAt   DateTime       @default(now()) @map("created_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, timestamp])
  @@index([patientId, source, timestamp])
  @@map("hrv_readings")
}

model BMIReading {
  id        String   @id @default(cuid())
  patientId String   @map("patient_id")
  timestamp DateTime @default(now())
  weightKg  Float    @map("weight_kg")
  heightCm  Float    @map("height_cm")
  bmi       Float
  createdAt DateTime @default(now()) @map("created_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, timestamp])
  @@map("bmi_readings")
}

model LabOrder {
  id          String      @id @default(cuid())
  patientId   String      @map("patient_id")
  visitId     String?     @map("visit_id")
  providerId  String      @map("provider_id")
  tests       String[]    // Array of test names/codes (e.g., ["CBC", "CMP", "A1C"])
  notes       String?
  status      LabOrderStatus @default(ORDERED)
  orderedAt   DateTime    @default(now()) @map("ordered_at")
  completedAt DateTime?   @map("completed_at")
  results     Json?       // Lab results when available
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  visit   Visit?  @relation(fields: [visitId], references: [id], onDelete: SetNull)

  @@index([patientId, status])
  @@index([providerId, status])
  @@index([status, orderedAt])
  @@map("lab_orders")
}

model Referral {
  id          String         @id @default(cuid())
  patientId   String         @map("patient_id")
  visitId     String?        @map("visit_id")
  providerId  String         @map("provider_id")
  specialty   String         // e.g., "Cardiology", "Endocrinology", "Physical Therapy"
  reason      String
  priority    ReferralPriority @default(ROUTINE)
  status      ReferralStatus @default(PENDING)
  referredTo  String?        @map("referred_to") // Provider/clinic name
  notes       String?
  sentAt      DateTime?      @map("sent_at")
  completedAt DateTime?      @map("completed_at")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  visit   Visit?  @relation(fields: [visitId], references: [id], onDelete: SetNull)

  @@index([patientId, status])
  @@index([providerId, status])
  @@index([status, createdAt])
  @@map("referrals")
}

model ExcuseNote {
  id          String          @id @default(cuid())
  patientId   String          @map("patient_id")
  visitId     String?         @map("visit_id")
  providerId  String          @map("provider_id")
  type        ExcuseNoteType
  startDate   DateTime        @map("start_date")
  endDate     DateTime        @map("end_date")
  reason      String
  restrictions String?        // e.g., "No heavy lifting", "Light duty only"
  status      ExcuseNoteStatus @default(DRAFT)
  sentAt      DateTime?       @map("sent_at")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  visit   Visit?  @relation(fields: [visitId], references: [id], onDelete: SetNull)

  @@index([patientId, status])
  @@index([providerId, status])
  @@index([status, createdAt])
  @@map("excuse_notes")
}

model ClinicalNote {
  id                    String   @id @default(cuid())
  patientId             String   @map("patient_id")
  encounterId           String?  @map("encounter_id")
  providerId            String?  @map("provider_id")
  type                  String   // SOAP, H&P, Consult, Discharge, Progress, Symptom Note
  title                 String
  content               String
  source                String?  // voice, text, check-in
  // Multilingual fields for clinician dictation
  noteOriginalText      String?  @map("note_original_text") // Original dictation text
  noteOriginalLanguage  String?  @map("note_original_language") // ISO language code
  noteCanonicalText     String?  @map("note_canonical_text") // English canonical version
  noteLanguageForDisplay String? @default("en") @map("note_language_for_display") // Language to display (en or original)
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  visit   Visit?  @relation("VisitClinicalNotes", fields: [encounterId], references: [id], onDelete: SetNull)

  @@index([patientId, createdAt])
  @@index([encounterId])
  @@index([providerId])
  @@map("clinical_notes")
}

enum LabOrderStatus {
  ORDERED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ReferralPriority {
  ROUTINE
  URGENT
  STAT
}

enum ReferralStatus {
  PENDING
  SENT
  ACCEPTED
  COMPLETED
  CANCELLED
}

enum ExcuseNoteType {
  WORK
  SCHOOL
  GENERAL
}

enum ExcuseNoteStatus {
  DRAFT
  SENT
  EXPIRED
}
